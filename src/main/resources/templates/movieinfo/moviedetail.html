<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="../css/bootstrap.min.css">
<style type="text/css">
#header-container {
	width: 100%;
	background-color: #ffffff;
	position: relative;
	z-index: 10;
}
footer-container {
	position: relative;
	width: 100%;
}
.tab-container {
    display: flex;
    justify-content: center;
    border-bottom: 2px solid #ddd;
    margin-top: 20px;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    color: #666;
}
.tab.active {
    border-bottom: 2px solid black;
    color: black;
}
#tab-content {
    margin-top: 20px;
    padding: 10px;
}
.review-input {
    margin-bottom: 20px;
}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

	<!-- í—¤ë” -->
	<div id="header-container">
		<div th:replace="~{layouts/header}"></div>
	</div>

	<div class="container" align="center" style="margin-top:100px; padding-bottom:100px;">
		<table style="width: 900px; margin-left: auto; margin-right: auto;">
			<tr>
				<td rowspan="4" style="width:310px; padding-right:50px;">
					<img alt="ì´ë¯¸ì§€" th:src="|/movie_poster/${movie_info.poster1}|" width="300" height="400">
				</td>
				<td align="left" style="height:50px;">[[${movie_info.title}]]</td>
			</tr>
			<tr>
				<td style="height:20px;">[[${movie_info.title}]] | [[${movie_info.runningtime}]] | [[${movie_info.agerating}]] | [[${movie_info.total}]]</td>
			</tr>
			<tr>
				<td>
					<pre>[[${movie_info.synopsis}]]</pre>
				</td>
			</tr>
			<tr>
				<td style="height:50px;">
					<a href="#">ì˜ˆë§¤í•˜ê¸°</a>
				</td>
			</tr>
		</table>
	</div>

	<!-- ğŸ”¹ ìƒì„¸ì •ë³´ | ê´€ëŒí‰(0) íƒ­ -->
	<div class="tab-container">
	    <span class="tab active" id="detail-tab">ìƒì„¸ì •ë³´</span>
	    <span class="tab" id="review-tab">ê´€ëŒí‰ (<span id="review-count">0</span>)</span>
	</div>

	<!-- ğŸ”¹ ë¦¬ë·° ì…ë ¥ & ëª©ë¡ -->
	<div id="tab-content" style="display: none;">
	    <div id="review-section">
	        <!-- ë¦¬ë·° ì…ë ¥ í¼ -->
	        <div class="review-input">
	            <textarea id="comment" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
	            <input type="number" id="rating" min="1" max="10" placeholder="ë³„ì  (1~10)">
	            <button id="submit-review-btn">ë¦¬ë·° ë“±ë¡</button>
	        </div>
	
	        <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
	        <ul id="review-list">
	            <!-- AJAXë¡œ ë¶ˆëŸ¬ì˜¨ ë¦¬ë·°ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
	        </ul>
	    </div>
	</div>

	<!--  footer -->
	<div id="footer-container">
		<div th:replace="~{layouts/footer}"></div>
	</div>

<script th:inline="javascript">
$(document).ready(function () {

    let sessionUserId = /*[[${sessionMemid}]]*/ '';
    let moviecode = /*[[${movie_info.moviecode}]]*/ 1;

    $(".tab").click(function () {
        $(".tab").removeClass("active");
        $(this).addClass("active");

        if ($(this).attr("id") === "review-tab") {
            $("#tab-content").show();
            loadReviews();
        } else {
            $("#tab-content").hide();
        }
    });

    // ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    function loadReviews() {
        $.ajax({
            url: `/movieinfo/review?start=1&end=5&moviecode=${moviecode}`,
            type: "GET",
            success: function (reviews) {
                $("#review-list").html("");
                $("#review-count").text(reviews.length);

                reviews.forEach(function (r) {
                    let replyBtn = '';
                    if(r.user_id === sessionUserId){
                        replyBtn = `<button class="reply-btn">ë‹µê¸€ë‹¬ê¸°</button>`;
                    }
                    $("#review-list").append(`
                        <li>
                            <strong>${r.user_id}</strong>: ${r.review_comment} (â­ ${r.rating}/10)
                            ${replyBtn}
                        </li>
                    `);
                });
            }
        });
    } // loadReviews() í•¨ìˆ˜ì˜ ì¤‘ê´„í˜¸ ë‹«ìŒ ì²˜ë¦¬

    // ë¦¬ë·° ë“±ë¡ í´ë¦­ ì´ë²¤íŠ¸ (loadReviews í•¨ìˆ˜ ë°”ê¹¥ì— ë³„ë„ ìœ„ì¹˜)
    $("#submit-review-btn").click(function () {
        const review = {
            moviecode: moviecode,
            user_id: sessionUserId, // ì„¸ì…˜ì˜ ì‚¬ìš©ì ID ì‚¬ìš©
            review_comment: $("#comment").val(),
            rating: $("#rating").val()
        };

        $.ajax({
            url: "/movieinfo/review",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(review),
            success: function (savedReview) {
                $("#review-list").prepend(`
                    <li><strong>${savedReview.user_id}</strong>: ${savedReview.review_comment} (â­ ${savedReview.rating}/10)</li>
                `);
                $("#comment").val("");
                $("#rating").val("");

                let currentCount = parseInt($("#review-count").text()) + 1;
                $("#review-count").text(currentCount);
            }
        });
    });

});
</script>


</body>
</html>
